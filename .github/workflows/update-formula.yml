name: Update Formula on Upstream Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version from ricochet-rs/cli (e.g., v0.2.0 or 0.2.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Setup tap
        run: |
          mkdir -p "$(brew --repo)/Library/Taps/ricochet-rs"
          ln -sf "$GITHUB_WORKSPACE" "$(brew --repo)/Library/Taps/ricochet-rs/homebrew-tap"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Switch remote to SSH for push with deploy key
          git remote set-url origin git@github.com:${{ github.repository }}.git

      - name: Parse version
        id: version
        run: |
          echo "Raw input: '${{ inputs.version }}'"
          VERSION="${{ inputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "❌ Error: version input is required but was empty"
            exit 1
          fi
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Updating to version: ${VERSION}"

      - name: Update formula with brew bump-formula-pr
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          URL="https://github.com/ricochet-rs/cli/archive/refs/tags/v${VERSION}.tar.gz"

          echo "Updating formula to version ${VERSION}"
          echo "Source URL: ${URL}"

          brew bump-formula-pr \
            --url="${URL}" \
            --write-only \
            --no-browse \
            ricochet-rs/tap/ricochet

      - name: Commit, push, and create tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if git diff --quiet Formula/ricochet.rb; then
            echo "❌ No changes to formula - bump may have failed"
            exit 1
          fi

          # Set up SSH
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.ACTIONS_DEPLOY_KEY }}"

          git add Formula/ricochet.rb
          git commit -m "ricochet ${VERSION}"
          git push
          echo "✅ Formula updated and pushed"

          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

          echo "Tag v${VERSION} created"
          echo "Bottle build workflow will trigger automatically"
