name: Build and Publish Bottles

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-formula:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin git@github.com:${{ github.repository }}.git

      - name: Update formula and push
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          URL="https://github.com/ricochet-rs/cli/archive/refs/tags/v${VERSION}.tar.gz"

          # Download and extract to get Cargo.lock
          curl -sL "${URL}" -o cli.tar.gz
          SHA256=$(shasum -a 256 cli.tar.gz | cut -d' ' -f1)
          tar -xzf cli.tar.gz

          # Extract ricochet-core commit from Cargo.lock
          CORE_COMMIT=$(grep -A2 'name = "ricochet-core"' "cli-${VERSION}/Cargo.lock" | grep 'source = "git' | sed 's/.*#\([a-f0-9]*\)"/\1/')
          echo "Updating formula to v${VERSION} (SHA256: ${SHA256}, ricochet-core: ${CORE_COMMIT})"

          sed -i "s|url \"https://github.com/ricochet-rs/cli/archive/refs/tags/v[^\"]*\"|url \"${URL}\"|" Formula/ricochet.rb
          sed -i "s|^\([[:space:]]*\)sha256 \"[a-f0-9]\{64\}\"|\1sha256 \"${SHA256}\"|" Formula/ricochet.rb
          sed -i "s|revision: \"[a-f0-9]*\"|revision: \"${CORE_COMMIT}\"|" Formula/ricochet.rb
          sed -i "s|root_url \"https://github.com/${{ github.repository }}/releases/download/v[^\"]*\"|root_url \"https://github.com/${{ github.repository }}/releases/download/v${VERSION}\"|" Formula/ricochet.rb

          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.ACTIONS_DEPLOY_KEY }}"

          if ! git diff --quiet Formula/ricochet.rb; then
            git add Formula/ricochet.rb
            git commit -m "ricochet ${VERSION}"
            git push origin HEAD:main
          fi

  build-bottle:
    needs: update-formula
    timeout-minutes: 15
    if: always() && (needs.update-formula.result == 'success' || needs.update-formula.result == 'skipped')
    strategy:
      matrix:
        os:
          - macos-15
          - macos-15-intel
          - macos-14
          - macos-26
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Get latest main
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Configure git auth for private dependencies
        run: |
          echo "machine github.com login x-access-token password ${{ secrets.RICOCHET_PAT }}" > ~/.netrc
          chmod 600 ~/.netrc

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main

      - name: Link tap
        run: |
          mkdir -p "$(brew --repo)/Library/Taps/ricochet-rs"
          ln -sf "$GITHUB_WORKSPACE" "$(brew --repo)/Library/Taps/ricochet-rs/homebrew-tap"

      - name: Extract version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep -m1 'url' Formula/ricochet.rb | sed 's/.*\/v\([0-9.]*[0-9]\).*/\1/')
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update formula to match tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          URL="https://github.com/ricochet-rs/cli/archive/refs/tags/v${VERSION}.tar.gz"

          # Download and extract to get Cargo.lock
          curl -sL --max-time 60 "${URL}" -o cli.tar.gz
          SHA256=$(shasum -a 256 cli.tar.gz | cut -d' ' -f1)
          tar -xzf cli.tar.gz

          # Extract ricochet-core commit from Cargo.lock
          CORE_COMMIT=$(grep -A2 'name = "ricochet-core"' "cli-${VERSION}/Cargo.lock" | grep 'source = "git' | sed 's/.*#\([a-f0-9]*\)"/\1/')
          echo "Updating formula to v${VERSION} (SHA256: ${SHA256}, ricochet-core: ${CORE_COMMIT})"

          sed -i '' "s|url \"https://github.com/ricochet-rs/cli/archive/refs/tags/v[^\"]*\"|url \"${URL}\"|" Formula/ricochet.rb
          sed -i '' "s|sha256 \"[a-f0-9]\{64\}\"|sha256 \"${SHA256}\"|" Formula/ricochet.rb
          sed -i '' "s|revision: \"[a-f0-9]*\"|revision: \"${CORE_COMMIT}\"|" Formula/ricochet.rb
          sed -i '' "s|root_url \"https://github.com/${{ github.repository }}/releases/download/v[^\"]*\"|root_url \"https://github.com/${{ github.repository }}/releases/download/v${VERSION}\"|" Formula/ricochet.rb

      - name: Build bottle
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
        run: |
          brew install --build-bottle --verbose ricochet-rs/tap/ricochet
          brew bottle --no-rebuild --json --root-url=https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }} ricochet-rs/tap/ricochet

      - name: Upload bottles
        uses: actions/upload-artifact@v7
        with:
          name: bottles-${{ matrix.os }}
          path: |
            *.bottle.*
            *.json

  upload-bottles:
    needs: build-bottle
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download bottles
        uses: actions/download-artifact@v8
        with:
          pattern: bottles-*
          merge-multiple: true

      - name: Rename bottles
        run: |
          for file in ricochet--*.bottle.tar.gz; do
            [ -f "$file" ] && mv "$file" "${file/ricochet--/ricochet-}"
          done
          for file in ricochet--*.bottle.json; do
            [ -f "$file" ] && sed -i 's/ricochet--/ricochet-/g' "$file" && mv "$file" "${file/ricochet--/ricochet-}"
          done

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          if gh release view "$VERSION" --repo ${{ github.repository }} >/dev/null 2>&1; then
            gh release upload "$VERSION" ./*.bottle.* --repo ${{ github.repository }} --clobber
          else
            gh release create "$VERSION" --repo ${{ github.repository }} --title "$VERSION" --notes "Release $VERSION" ./*.bottle.*
          fi
